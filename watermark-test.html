<!DOCTYPE html>
<html>
<head>
    <title>Watermark Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Watermark Functionality Test</h1>
    
    <div class="test-section">
        <h2>Test Instructions</h2>
        <ol>
            <li>Open the application at <a href="http://localhost:3003" target="_blank">http://localhost:3003</a></li>
            <li>Open browser console (F12)</li>
            <li>Copy and paste the test script below into the console</li>
            <li>Run the test functions step by step</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Test Script</h2>
        <textarea id="testScript" rows="30" cols="100" readonly>
// Watermark Test Script
console.log('üß™ Starting Watermark Test...');

// Test 1: Check if Redux store is available
function test1_checkStore() {
    console.log('\nüìã Test 1: Checking Redux Store...');
    
    // Try to access store from window
    if (window.__REDUX_DEVTOOLS_EXTENSION__) {
        console.log('‚úÖ Redux DevTools detected');
    }
    
    // Try to access store from React DevTools
    const reactFiber = document.querySelector('#root')._reactInternalFiber || 
                      document.querySelector('#root')._reactInternals;
    
    if (reactFiber) {
        console.log('‚úÖ React Fiber detected');
        
        // Navigate through React tree to find store
        let current = reactFiber;
        let store = null;
        
        function findStore(node, depth = 0) {
            if (depth > 10) return null;
            
            if (node?.memoizedProps?.store) {
                return node.memoizedProps.store;
            }
            
            if (node?.child) {
                const childStore = findStore(node.child, depth + 1);
                if (childStore) return childStore;
            }
            
            if (node?.sibling) {
                const siblingStore = findStore(node.sibling, depth + 1);
                if (siblingStore) return siblingStore;
            }
            
            return null;
        }
        
        store = findStore(current);
        
        if (store) {
            window.testStore = store;
            console.log('‚úÖ Store found and saved to window.testStore');
            console.log('Current state:', store.getState());
            return true;
        }
    }
    
    console.log('‚ùå Could not access Redux store');
    return false;
}

// Test 2: Add text watermark
function test2_addTextWatermark() {
    console.log('\nüìù Test 2: Adding Text Watermark...');
    
    if (!window.testStore) {
        console.log('‚ùå Store not available. Run test1_checkStore() first.');
        return false;
    }
    
    const store = window.testStore;
    
    try {
        // Add text watermark
        store.dispatch({
            type: 'branding/updateCurrentBranding',
            payload: {
                watermark: {
                    type: 'text',
                    text: 'CONFIDENTIAL TEST',
                    transparency: 0.3,
                    rotation: 45,
                    image: null,
                    processedImage: null,
                    storageKey: null
                }
            }
        });
        
        console.log('‚úÖ Text watermark added');
        console.log('Updated branding:', store.getState().branding.currentBranding);
        return true;
    } catch (error) {
        console.log('‚ùå Error adding text watermark:', error);
        return false;
    }
}

// Test 3: Sync to proposal
function test3_syncToProposal() {
    console.log('\nüîÑ Test 3: Syncing to Proposal...');
    
    if (!window.testStore) {
        console.log('‚ùå Store not available. Run test1_checkStore() first.');
        return false;
    }
    
    const store = window.testStore;
    const state = store.getState();
    
    try {
        if (state.proposals.currentProposal) {
            store.dispatch({
                type: 'proposals/updateProposal',
                payload: {
                    id: state.proposals.currentProposal.id,
                    updates: {
                        branding: state.branding.currentBranding
                    }
                }
            });
            
            console.log('‚úÖ Branding synced to proposal');
            console.log('Updated proposal branding:', store.getState().proposals.currentProposal.branding);
            return true;
        } else {
            console.log('‚ùå No current proposal found');
            return false;
        }
    } catch (error) {
        console.log('‚ùå Error syncing to proposal:', error);
        return false;
    }
}

// Test 4: Test export function
function test4_testExport() {
    console.log('\nüì§ Test 4: Testing Export Function...');
    
    if (!window.testStore) {
        console.log('‚ùå Store not available. Run test1_checkStore() first.');
        return false;
    }
    
    const state = window.testStore.getState();
    
    // Check if export function is available
    if (typeof window.exportToDocx === 'function') {
        console.log('‚úÖ exportToDocx function found');
        
        try {
            // Call export function with current proposal and branding
            window.exportToDocx(
                state.proposals.currentProposal,
                state.proposals.currentProposal.branding || state.branding.currentBranding
            );
            console.log('‚úÖ Export function called - check console for debug logs');
            return true;
        } catch (error) {
            console.log('‚ùå Error calling export function:', error);
            return false;
        }
    } else {
        console.log('‚ùå exportToDocx function not found on window');
        
        // Try to find export button and click it
        const exportButtons = Array.from(document.querySelectorAll('button')).filter(btn => 
            btn.textContent.toLowerCase().includes('export') || 
            btn.textContent.toLowerCase().includes('docx')
        );
        
        if (exportButtons.length > 0) {
            console.log(`‚úÖ Found ${exportButtons.length} export button(s)`);
            exportButtons[0].click();
            console.log('‚úÖ Export button clicked - check console for debug logs');
            return true;
        } else {
            console.log('‚ùå No export buttons found');
            return false;
        }
    }
}

// Run all tests
function runAllTests() {
    console.log('üöÄ Running All Tests...\n');
    
    const results = {
        test1: test1_checkStore(),
        test2: false,
        test3: false,
        test4: false
    };
    
    if (results.test1) {
        results.test2 = test2_addTextWatermark();
        
        if (results.test2) {
            results.test3 = test3_syncToProposal();
            
            if (results.test3) {
                setTimeout(() => {
                    results.test4 = test4_testExport();
                    
                    console.log('\nüìä Test Results:');
                    console.log('Store Access:', results.test1 ? '‚úÖ' : '‚ùå');
                    console.log('Add Watermark:', results.test2 ? '‚úÖ' : '‚ùå');
                    console.log('Sync to Proposal:', results.test3 ? '‚úÖ' : '‚ùå');
                    console.log('Export Test:', results.test4 ? '‚úÖ' : '‚ùå');
                    
                    if (results.test1 && results.test2 && results.test3 && results.test4) {
                        console.log('\nüéâ All tests passed! Check for watermark debug logs above.');
                    } else {
                        console.log('\n‚ö†Ô∏è Some tests failed. Check individual test results.');
                    }
                }, 1000);
            }
        }
    }
}

// Make functions available globally
window.test1_checkStore = test1_checkStore;
window.test2_addTextWatermark = test2_addTextWatermark;
window.test3_syncToProposal = test3_syncToProposal;
window.test4_testExport = test4_testExport;
window.runAllTests = runAllTests;

console.log('üß™ Test functions loaded!');
console.log('Run runAllTests() to run all tests, or run individual tests:');
console.log('- test1_checkStore()');
console.log('- test2_addTextWatermark()');
console.log('- test3_syncToProposal()');
console.log('- test4_testExport()');
        </textarea>
    </div>

    <div class="test-section">
        <h2>Quick Actions</h2>
        <button onclick="copyScript()">Copy Test Script</button>
        <button onclick="window.open('http://localhost:3003', '_blank')">Open App</button>
    </div>

    <script>
        function copyScript() {
            const textarea = document.getElementById('testScript');
            textarea.select();
            document.execCommand('copy');
            alert('Test script copied to clipboard!');
        }
    </script>
</body>
</html>